#
# Check for:
#
# - 1 OpenStackControlPlane
# - 1 OpenStackVMSet
# - 1 VirtualMachine
# - 6 OpenStackNets (IP reservations)
# - 1 OpenStackIPSet (IP reservations)
#

apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackControlPlane
metadata:
  name: overcloud
  namespace: openstack
spec:
  virtualMachineRoles:
    controller:
      roleCount: 1
status:
  vipStatus:
    controlplane:
      annotatedForDeletion: false
      hostRef: overcloud
      hostname: controlplane
      ipaddresses:
        ctlplane: 192.168.25.100/24
        external: 10.0.0.10/24
        internal_api: 172.17.0.10/24
        storage: 172.18.0.10/24
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackVMSet
metadata:
  finalizers:
  - openstackvmsets.osp-director.openstack.org/virtualmachine
  name: controller
  namespace: openstack
spec:
  baseImageVolumeName: controller-base-img
  cores: 6
  ctlplaneInterface: enp2s0
  deploymentSSHSecret: osp-controlplane-ssh-keys
  diskSize: 50
  domainName: ostest.test.metalkube.org
  isTripleoRole: true
  memory: 20
  networks:
  - ctlplane
  - external
  - internal_api
  - storage
  - storage_mgmt
  - tenant
  passwordSecret: userpassword
  roleName: Controller
  storageClass: host-nfs-storageclass
  vmCount: 1
status:
  baseImageDVReady: true
  conditions:
  - message: All requested VirtualMachines have been provisioned
    reason: All requested VirtualMachines have been provisioned
    status: "True"
    type: Provisioned
  provisioningStatus:
    readyCount: 1
    reason: All requested VirtualMachines have been provisioned
    state: Provisioned
  vmHosts:
    controller-2:
      annotatedForDeletion: false
      hostRef: controller-2
      hostname: controller-2
      ipaddresses:
        ctlplane: 192.168.25.104/24
        external: 10.0.0.14/24
        internal_api: 172.17.0.14/24
        storage: 172.18.0.13/24
        storage_mgmt: 172.19.0.13/24
        tenant: 172.20.0.12/24
      provisioningState: Provisioned
---
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachine
metadata:
  name: controller-2
  namespace: openstack
status:
  conditions:
  - status: "True"
    type: Ready
  created: true
  ready: true
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: ctlplane
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet ctlplane has been successfully configured on targeted node(s)
    reason: OpenStackNet ctlplane has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 5
  roleReservations:
    ControlPlane:
      addToPredictableIPs: true
      reservations:
      - deleted: false
        hostname: controlplane
        ip: 192.168.25.100
        vip: true
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 192.168.25.102
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 192.168.25.103
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 192.168.25.104
        vip: false
    OpenstackClientopenstackclient:
      addToPredictableIPs: false
      reservations:
      - deleted: false
        hostname: openstackclient-0
        ip: 192.168.25.101
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: external
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet external has been successfully configured on targeted node(s)
    reason: OpenStackNet external has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 5
  roleReservations:
    ControlPlane:
      addToPredictableIPs: true
      reservations:
      - deleted: false
        hostname: controlplane
        ip: 10.0.0.10
        vip: true
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 10.0.0.12
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 10.0.0.13
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 10.0.0.14
        vip: false
    OpenstackClientopenstackclient:
      addToPredictableIPs: false
      reservations:
      - deleted: false
        hostname: openstackclient-0
        ip: 10.0.0.11
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: internalapi
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet internalapi has been successfully configured on targeted node(s)
    reason: OpenStackNet internalapi has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 5
  roleReservations:
    ControlPlane:
      addToPredictableIPs: true
      reservations:
      - deleted: false
        hostname: controlplane
        ip: 172.17.0.10
        vip: true
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 172.17.0.12
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 172.17.0.13
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 172.17.0.14
        vip: false
    OpenstackClientopenstackclient:
      addToPredictableIPs: false
      reservations:
      - deleted: false
        hostname: openstackclient-0
        ip: 172.17.0.11
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: storage
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet storage has been successfully configured on targeted node(s)
    reason: OpenStackNet storage has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 4
  roleReservations:
    ControlPlane:
      addToPredictableIPs: true
      reservations:
      - deleted: false
        hostname: controlplane
        ip: 172.18.0.10
        vip: true
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 172.18.0.11
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 172.18.0.12
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 172.18.0.13
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: storagemgmt
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet storagemgmt has been successfully configured on targeted node(s)
    reason: OpenStackNet storagemgmt has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 4
  roleReservations:
    ControlPlane:
      addToPredictableIPs: true
      reservations:
      - deleted: false
        hostname: controlplane
        ip: 172.19.0.10
        vip: true
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 172.19.0.11
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 172.19.0.12
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 172.19.0.13
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackNet
metadata:
  finalizers:
  - openstacknet.osp-director.openstack.org
  name: tenant
  namespace: openstack
status:
  conditions:
  - message: OpenStackNet tenant has been successfully configured on targeted node(s)
    reason: OpenStackNet tenant has been successfully configured on targeted node(s)
    status: "True"
    type: Configured
  currentState: Configured
  reservedIpCount: 3
  roleReservations:
    Controller:
      addToPredictableIPs: true
      reservations:
      - deleted: true
        hostname: controller-0
        ip: 172.20.0.10
        vip: false
      - deleted: true
        hostname: controller-1
        ip: 172.20.0.11
        vip: false
      - deleted: false
        hostname: controller-2
        ip: 172.20.0.12
        vip: false
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackIPSet
metadata:
  finalizers:
  - osp-director.openstack.org
  labels:
    addToPredictableIPsLabel: "true"
  name: controller
  namespace: openstack
spec:
  addToPredictableIPs: true
  hostCount: 1
  hostNameRefs:
    controller-2: controller-2
  networks:
  - ctlplane
  - external
  - internal_api
  - storage
  - storage_mgmt
  - tenant
  roleName: Controller
  vip: false
status:
  hosts:
    controller-2:
      ipaddresses:
        ctlplane: 192.168.25.104/24
        external: 10.0.0.14/24
        internal_api: 172.17.0.14/24
        storage: 172.18.0.13/24
        storage_mgmt: 172.19.0.13/24
        tenant: 172.20.0.12/24
  networks:
    ctlplane:
      allocationEnd: 192.168.25.250
      allocationStart: 192.168.25.100
      cidr: 192.168.25.0/24
      gateway: 192.168.25.1
      vlan: 0
    external:
      allocationEnd: 10.0.0.250
      allocationStart: 10.0.0.10
      cidr: 10.0.0.0/24
      gateway: 10.0.0.1
      vlan: 0
    internalapi:
      allocationEnd: 172.17.0.250
      allocationStart: 172.17.0.10
      cidr: 172.17.0.0/24
      gateway: ""
      vlan: 20
    storage:
      allocationEnd: 172.18.0.250
      allocationStart: 172.18.0.10
      cidr: 172.18.0.0/24
      gateway: ""
      vlan: 30
    storagemgmt:
      allocationEnd: 172.19.0.250
      allocationStart: 172.19.0.10
      cidr: 172.19.0.0/24
      gateway: ""
      vlan: 40
    tenant:
      allocationEnd: 172.20.0.250
      allocationStart: 172.20.0.10
      cidr: 172.20.0.0/24
      gateway: ""
      vlan: 50
---
apiVersion: osp-director.openstack.org/v1beta1
kind: OpenStackMACAddress
metadata:
  name: overcloud
  namespace: openstack
spec:
  physNetworks:
  - macPrefix: fa:16:3a
    name: datacentre
  - macPrefix: fa:16:3b
    name: datacentre2
status:
  reservedMACCount: 6
---
apiVersion: kuttl.dev/v1beta1
kind: TestAssert
namespaced: true
timeout: 20
commands:
# verify scaled down controller nodes MAC entries are marked as deleted
  - script: |
      set -x
      deletedFlaggedMAC=$(oc get -n openstack osmacaddr overcloud -o json | jq -r '.status.macReservations[] | select(.deleted==true) | .deleted' | wc -l)
      if [ $deletedFlaggedMAC -eq 2 ]; then
          exit 0
      else
          exit 1
      fi
